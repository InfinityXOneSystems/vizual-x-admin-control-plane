name: Preflight Guardian

# This workflow acts as the foundational validation layer for autonomous AI coding workflows.
# It provides zero-tolerance validation gates with clear, actionable error logs for self-correction.

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
      - 'feature/**'
      - 'fix/**'
      - 'copilot/**'

jobs:
  preflight-guardian:
    name: üõ°Ô∏è Preflight Guardian Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context in error messages
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üì¶ Dependency Check (Reproducible Build)
        id: dependencies
        run: |
          echo "::group::Installing Dependencies with npm ci"
          npm ci --verbose
          echo "::endgroup::"
          echo "‚úÖ Dependencies installed successfully"
        continue-on-error: false
      
      - name: üîç Type Safety Check
        id: typecheck
        run: |
          echo "::group::Running TypeScript Type Check"
          echo "üîç Checking type safety with: npm run typecheck"
          set -o pipefail
          npm run typecheck 2>&1 | tee typecheck.log
          TYPECHECK_EXIT=$?
          echo "::endgroup::"
          
          if [ $TYPECHECK_EXIT -ne 0 ]; then
            echo "::error::‚ùå Type check failed. Review errors above."
            echo "::error::Command: npm run typecheck"
            echo "::error::AI Agent Action: Fix type errors reported in typecheck.log"
            exit 1
          fi
          
          echo "‚úÖ Type check passed"
        continue-on-error: false
      
      - name: üßπ Code Integrity Check
        id: integrity
        run: |
          echo "::group::Running Code Integrity Validation"
          echo "üßπ Validating code syntax and structure"
          
          # Use TypeScript compiler for syntax validation
          echo "Running: npx tsc --noEmit --skipLibCheck"
          set -o pipefail
          npx tsc --noEmit --skipLibCheck 2>&1 | tee integrity.log
          INTEGRITY_EXIT=$?
          echo "::endgroup::"
          
          if [ $INTEGRITY_EXIT -ne 0 ]; then
            echo "::error::‚ùå Code integrity check failed"
            echo "::error::Command: npx tsc --noEmit --skipLibCheck"
            echo "::error::AI Agent Action: Fix syntax errors reported in integrity.log"
            exit 1
          fi
          
          echo "‚úÖ Code integrity check passed"
        continue-on-error: false
      
      - name: üèóÔ∏è Build Verification (Production Compile)
        id: build
        run: |
          echo "::group::Building for Production"
          echo "üèóÔ∏è Building project with: npm run build"
          set -o pipefail
          npm run build 2>&1 | tee build.log
          BUILD_EXIT=$?
          echo "::endgroup::"
          
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "::error::‚ùå Build failed"
            echo "::error::Command: npm run build"
            echo "::error::AI Agent Action: Fix build errors reported in build.log"
            grep -i "error" build.log || cat build.log
            exit 1
          fi
          
          echo "‚úÖ Build verification passed"
        continue-on-error: false
      
      - name: üìä Validation Summary
        if: always()
        run: |
          echo "::group::Preflight Guardian Summary"
          echo "=========================================="
          echo "üõ°Ô∏è  PREFLIGHT GUARDIAN VALIDATION REPORT"
          echo "=========================================="
          echo ""
          
          if [ "${{ steps.dependencies.outcome }}" == "success" ]; then
            echo "‚úÖ Dependency Check: PASSED"
          else
            echo "‚ùå Dependency Check: FAILED"
          fi
          
          if [ "${{ steps.typecheck.outcome }}" == "success" ]; then
            echo "‚úÖ Type Safety Check: PASSED"
          else
            echo "‚ùå Type Safety Check: FAILED"
          fi
          
          if [ "${{ steps.integrity.outcome }}" == "success" ]; then
            echo "‚úÖ Code Integrity Check: PASSED"
          else
            echo "‚ùå Code Integrity Check: FAILED"
          fi
          
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "‚úÖ Build Verification: PASSED"
          else
            echo "‚ùå Build Verification: FAILED"
          fi
          
          echo ""
          echo "=========================================="
          
          # Fail the job if any step failed
          if [ "${{ steps.dependencies.outcome }}" != "success" ] || \
             [ "${{ steps.typecheck.outcome }}" != "success" ] || \
             [ "${{ steps.integrity.outcome }}" != "success" ] || \
             [ "${{ steps.build.outcome }}" != "success" ]; then
            echo "::error::üö® PREFLIGHT GUARDIAN VALIDATION FAILED"
            echo "::error::Review the error logs above for actionable fixes"
            exit 1
          fi
          
          echo "üéâ ALL VALIDATION GATES PASSED"
          echo "::endgroup::"
      
      - name: üì§ Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-guardian-logs
          path: |
            typecheck.log
            integrity.log
            build.log
          retention-days: 7
